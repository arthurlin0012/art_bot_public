<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sticker Drawing App</title>

  <!-- Fabric.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h2 {
      margin-bottom: 10px;
    }

    select, button {
      margin: 10px;
      padding: 8px 12px;
      font-size: 16px;
    }

    canvas {
      border: 1px solid #ccc;
      margin-top: 20px;
      background: white;
      display: block;
    }
  </style>
</head>
<body>

  <h2>Choose a Template</h2>
  <select id="templateSelect"></select>
  <button id="downloadBtn">Download Sticker</button>

  <canvas id="c" width="500" height="500"></canvas>

  <script>
    console.log("Script starting");

    // Initialize Fabric canvas AFTER Fabric is loaded and DOM is ready
    window.addEventListener('load', function () {
      console.log("Window loaded");

      const canvasEl = document.getElementById('c');
      console.log("Canvas element:", canvasEl);

      const canvas = new fabric.Canvas('c', { isDrawingMode: true });
      console.log("Fabric canvas created:", canvas);

      // Brush settings
      canvas.freeDrawingBrush.width = 4;
      canvas.freeDrawingBrush.color = "#000000";

      // Template list (paths must exist!)
      const templates = [
        "templates/template1.png"
      ];

      const select = document.getElementById('templateSelect');
      const downloadBtn = document.getElementById('downloadBtn');

      // Populate dropdown
      templates.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.innerText = t.split('/').pop();
        select.appendChild(opt);
      });

      if (templates.length > 0) {
        select.value = templates[0];
      }

      function loadTemplate(path) {
        console.log("Loading template:", path);
        if (!path) return;

        fabric.Image.fromURL(path, function (img) {
          console.log("Image loaded:", img);

          img.scaleToWidth(canvas.getWidth());

          canvas.setBackgroundImage(
            img,
            canvas.renderAll.bind(canvas),
            {
              selectable: false
            }
          );
        }, {
          crossOrigin: 'anonymous'
        });
      }

      // Initial template
      loadTemplate(select.value);

      // Change template when dropdown changes
      select.addEventListener('change', function () {
        loadTemplate(this.value);
      });

      // Save / download the drawing
      function save() {
        canvas.discardActiveObject();
        canvas.renderAll();

        const dataURL = canvas.toDataURL({
          format: 'png'
        });

        const link = document.createElement('a');
        link.href = dataURL;
        link.download = 'sticker.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      downloadBtn.addEventListener('click', save);
    });
  </script>
</body>
</html>
